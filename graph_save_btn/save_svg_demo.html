<!DOCTYPE html>
<html lang="en">


<!-- The code uses small FileSaver.js library to save generated images and Canvas-to-Blob.js library to ensure browser compatibility. -->

<head>
	<title>How to properly export SVG D3 visualization to PNG or JPEG</title>
    <meta charset="utf-8">
    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
    <script src="https://d3js.org/d3.v6.js"></script>
 </head>

<body>
    <!-- Create a div where the graph will take place -->
    <div id="my_dataviz1">
        <h1>Basic demo</h1>
    </div>
    <!-- Save button -->
    <div>
        <button id='saveButton'>Export my D3 visualization to PNG</button>
    </div>
</body>


<script type="text/javascript">
    d3.selectAll("h1").style("color", "green")
    
    // set the dimensions and margins of the graph
    const margin = {top: 10, right: 30, bottom: 30, left: 60},
            width = 460 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;
        
    // append the svg object to the body of the page
    const svg = d3.select("#my_dataviz1")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);

    //Read the data
    d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/2_TwoNum.csv").then( function(data) {

        // Add X axis
        const x = d3.scaleLinear()
        .domain([0, 4000])
        .range([ 0, width ]);
        svg.append("g")
        .attr("transform", `translate(0, ${height})`)
        .call(d3.axisBottom(x));

        // Add Y axis
        const y = d3.scaleLinear()
        .domain([0, 500000])
        .range([ height, 0]);
        svg.append("g")
        .call(d3.axisLeft(y));

        // Add dots
        svg.append('g')
        .selectAll("dot")
        .data(data)
        .join("circle")
            .attr("cx", function (d) { return x(d.GrLivArea); } )
            .attr("cy", function (d) { return y(d.SalePrice); } )
            .attr("r", 1.5)
            .style("fill", "#69b3a2")
    })

    // SVG export part
    // ********************************************************************************************************************************************
    // Set-up the export button
    d3.select('#saveButton').on('click', function(){
        let svgString = getSVGString(d3.select('svg').node());
        svgString2Image( svgString, 2*width, 2*height, 'png', save ); // passes Blob and filesize String to the callback

        function save( dataBlob, filesize ){
            saveAs( dataBlob, 'D3 vis exported to PNG.png' ); // FileSaver.js function
        }
    });

    // Below are the functions that handle actual exporting:
    // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
    function getSVGString( svgNode ) {

        function appendCSS( cssText, element ) {
            const styleElement = document.createElement("style");
            styleElement.setAttribute("type","text/css"); 
            styleElement.innerHTML = cssText;
            const refNode = element.hasChildNodes() ? element.children[0] : null;
            element.insertBefore( styleElement, refNode );
        }

        function getCSSStyles( parentElement ) {

            function contains(str,arr) { 
                    return arr.indexOf( str ) === -1 ? false : true;
            }

            const selectorTextArr = [];

            // Add Parent element Id and Classes to the list
            selectorTextArr.push( '#'+parentElement.id );
            for (const c = 0; c < parentElement.classList.length; c++)
                    if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
                        selectorTextArr.push( '.'+parentElement.classList[c] );

            // Add Children element Ids and Classes to the list
            const nodes = parentElement.getElementsByTagName("*");
            for (let i = 0; i < nodes.length; i++) {
                const id = nodes[i].id;
                if ( !contains('#'+id, selectorTextArr) )
                    selectorTextArr.push( '#'+id );

                const classes = nodes[i].classList;
                for (let c = 0; c < classes.length; c++)
                    if ( !contains('.'+classes[c], selectorTextArr) )
                        selectorTextArr.push( '.'+classes[c] );
            }

            // Extract CSS Rules
            const extractedCSSText = "";
            for (let i = 0; i < document.styleSheets.length; i++) {
                const s = document.styleSheets[i];
                
                try {
                    if(!s.cssRules) continue;
                } catch( e ) {
                        if(e.name !== 'SecurityError') throw e; // for Firefox
                        continue;
                    }

                const cssRules = s.cssRules;
                for (const r = 0; r < cssRules.length; r++) {
                    if ( contains( cssRules[r].selectorText, selectorTextArr ) )
                        extractedCSSText += cssRules[r].cssText;
                }
            }
            

            return extractedCSSText;
        }

        svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
        let cssStyleText = getCSSStyles( svgNode );
        appendCSS( cssStyleText, svgNode );

        const serializer = new XMLSerializer();
        let svgString = serializer.serializeToString(svgNode);
        svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
        svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

        return svgString;
        

    }


    function svgString2Image( svgString, width, height, form, callback ) {
        let format = form ? form : 'png';

        const imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        canvas.width = width;
        canvas.height = height;

        const image = new Image();
        image.onload = function() {
            context.clearRect ( 0, 0, width, height );
            context.drawImage(image, 0, 0, width, height);

            canvas.toBlob( function(blob) {
                const filesize = Math.round( blob.length/1024 ) + ' KB';
                if ( callback ) callback( blob, filesize );
            });
        };

        image.src = imgsrc;
    }

</script>
</html>